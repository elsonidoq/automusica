<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
<head>
    <title><!-- Insert your title here --></title>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    
<!--    <script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/scriptaculous/1.8.2/scriptaculous.js'></script> -->
    <script type="text/javascript" src="js/Sound.js"></script>
    <link rel="stylesheet" type="text/css" href="css/starbox.css" />
    <style>
        *, html {
            padding:0;
            margin:0;
        }
        
        body {
            font-family: Georgia,Times,"Times New Roman",serif;
            color: #666;
        }
    </style>
</head>
<body style="margin:0 auto;" onload="javascript:resize();">
    <div id="content">
        <div id="player" style="position:absolute;top:35%;width:100%">
            <div id="wrapper" style="text-align:center;position:relative;"> 
                <a href="#" class="play_button_enabled" onclick="javascript:player.next()">
                <img border="0" src="images/play_blue.png"/>
                </a>
                <img border="0" class="play_button_disabled" src="images/play_gris.png" style="display:none" />
<!--                <span class="track-title" style="font-size:64px;">Nombre de la cancion</span> -->
            </div> 
            <div id="progress" style="height:4px;background:#CCC;">
                <div class="bar" style="width:0px;height:100%;background:#666;">
                </div>
            </div>
            <div id="stars-container" style="width:100%;text-align:center;margin-top:10px;display:none;position:absolute;">
<!--                <span>Como estuvo? &nbsp;&nbsp;</span> -->
                <div id="stars" style="position:relative;width:200px;">
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        
        var Player = function Player(playlist) {
            this._current_idx = -1;
            this._playing_interval = null;
            this.playlist = playlist;
            this.width = $(window).width();
            this.current_track = null;
            this.sounds = new Array();
            for (var i = 0; i < playlist.length; i++) {
                this.sounds.push(new Sound());
            }
            this.sound= this.sounds[0];
        }
        
        Player.prototype.play = function(track) {
            //console.log('curr_idx', this._current_idx);
            $(".play_button_disabled").show();
            $(".play_button_enabled").hide();
            this._set_progress(0);
            
            this.current_track = track;
            
            
            this.sound.loadSound(track, true)
            this.sound.start();
            
            var that = this;
            var binding_call = function () {
                that._check_progress();
            }
            this._playing_interval = setInterval(binding_call, 500);
            
        }
        
        Player.prototype._check_progress = function() {
            var width = this._get_progress();
            this._set_progress(width);
            
            if (width >= this.width){                
                clearInterval(this._playing_interval);
                this.onPlayEnded();
            }
            
        }
        
        Player.prototype._set_progress = function(value) {
            //console.log(Math.min(value, this.width));
//            $("#progress .bar").animate({"width": Math.min(value, this.width)});
        }
        
        Player.prototype._get_progress = function() {
            var pos = this.sound.getPosition();
            if (pos)
                return parseInt(this.width * pos / this.sound.getDuration());
            return 0
        }
        
        Player.prototype.next = function() {
            //TODO: validar limite
            this.play(this.playlist[++this._current_idx]);
        }
        
        Player.prototype.onPlayEnded = function() {
            //console.log('onPlayEnded');
            $("#stars-container").slideDown();
        }
        
        var playlist = ['mp3/vals_corto1.mp3',
                        'mp3/vals_corto1.mp3'],
//            sound = new Sound();
            player = new Player(playlist);
            
        var onRate = function(data) {
            //console.log(data);
            //todo: sacar valor
            player.sound = player.sounds[player._current_idx+1];
            /*var next = function() {
                player.next();
            }
            setTimeout(next, 1000);*/
            //console.log(player._current_idx);
            if (player._current_idx + 1 < player.playlist.size()) {
                $("#stars-container").slideUp();
                $(".play_button_enabled").show();
                $(".play_button_disabled").hide();
            } else {
                document.location= "gracias.html";
            }
        }
        
        var resize = function() {
            var ww = $(window).width();
            $("#content").css('height', $(window).height());
            $("#content").css('height', $(window).height());
            $("#stars").css('left', ww/2 - 32*7/2);
            player.width = ww;
        }
        
        $(window).resize(resize);
    </script>
</body>
</html>
